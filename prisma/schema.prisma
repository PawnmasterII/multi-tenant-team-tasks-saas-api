// Prisma schema for Multi-tenant SaaS API
// Stack: NestJS + PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum MembershipRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum MembershipStatus {
  ACTIVE
  INVITED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

enum ActorType {
  USER
  API_KEY
  SYSTEM
}

enum OutboxStatus {
  PENDING
  SENT
  FAILED
}

enum WebhookDeliveryStatus {
  PENDING
  SUCCESS
  FAILED
}

model User {
  id              String          @id @default(uuid()) @db.Uuid
  email           String          @unique
  passwordHash    String?
  name            String?
  emailVerifiedAt DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  memberships     Membership[]
  refreshTokens   RefreshToken[]

  projectsCreated Project[]       @relation("ProjectCreatedBy")
  tasksCreated    Task[]          @relation("TaskCreatedBy")
  tasksAssigned   Task[]          @relation("TaskAssignedTo")
  commentsCreated Comment[]       @relation("CommentCreatedBy")
}

model Organization {
  id        String       @id @default(uuid()) @db.Uuid
  name      String
  plan      String       @default("free")
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  memberships      Membership[]
  projects         Project[]
  tasks            Task[]
  comments         Comment[]
  apiKeys          ApiKey[]
  idempotencyKeys  IdempotencyKey[]
  auditLogs        AuditLog[]
  outboxEvents     OutboxEvent[]
  webhookEndpoints WebhookEndpoint[]
  webhookDeliveries WebhookDelivery[]
}

model Membership {
  orgId  String           @db.Uuid
  userId String           @db.Uuid

  role   MembershipRole
  status MembershipStatus @default(ACTIVE)

  createdAt DateTime @default(now())

  org  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([orgId, userId])
  @@index([userId])
}

model Project {
  id        String   @id @default(uuid()) @db.Uuid
  orgId     String   @db.Uuid
  name      String
  createdBy String?  @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  org      Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  creator  User?        @relation("ProjectCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  tasks    Task[]

  @@index([orgId, createdAt])
}

model Task {
  id             String       @id @default(uuid()) @db.Uuid
  orgId          String       @db.Uuid
  projectId      String       @db.Uuid

  title          String
  description    String?

  status         TaskStatus   @default(TODO)
  priority       TaskPriority @default(MEDIUM)

  assigneeUserId String?      @db.Uuid
  dueAt          DateTime?

  createdBy      String?      @db.Uuid

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  project   Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  creator   User?        @relation("TaskCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  assignee  User?        @relation("TaskAssignedTo", fields: [assigneeUserId], references: [id], onDelete: SetNull)

  comments  Comment[]

  @@index([orgId, projectId])
  @@index([orgId, status])
  @@index([orgId, updatedAt])
}

model Comment {
  id        String   @id @default(uuid()) @db.Uuid
  orgId     String   @db.Uuid
  taskId    String   @db.Uuid

  body      String
  createdBy String?  @db.Uuid

  createdAt DateTime @default(now())

  org     Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  task    Task         @relation(fields: [taskId], references: [id], onDelete: Cascade)
  creator User?        @relation("CommentCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([orgId, createdAt])
  @@index([orgId, taskId, createdAt])
}

model RefreshToken {
  id            String    @id @default(uuid()) @db.Uuid
  userId        String    @db.Uuid

  tokenHash     String
  rotatedFromId String?   @db.Uuid

  expiresAt     DateTime
  revokedAt     DateTime?

  createdAt     DateTime  @default(now())

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model ApiKey {
  id         String   @id @default(uuid()) @db.Uuid
  orgId      String   @db.Uuid

  name       String
  keyPrefix  String
  keyHash    String
  scopes     Json     @default("[]")

  lastUsedAt DateTime?
  revokedAt  DateTime?

  createdAt  DateTime @default(now())

  org        Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, createdAt])
  @@index([keyPrefix])
}

model IdempotencyKey {
  orgId         String   @db.Uuid
  key           String

  requestHash   String
  responseCode  Int
  responseBody  Json

  createdAt     DateTime @default(now())

  org           Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@id([orgId, key])
  @@index([orgId, createdAt])
}

model AuditLog {
  id           String    @id @default(uuid()) @db.Uuid
  orgId        String    @db.Uuid

  actorType    ActorType
  actorId      String?

  action       String
  resourceType String
  resourceId   String?

  ip           String?
  userAgent    String?

  metadata     Json      @default("{}")

  createdAt    DateTime  @default(now())

  org          Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, createdAt])
  @@index([orgId, action])
}

model OutboxEvent {
  id            String      @id @default(uuid()) @db.Uuid
  orgId         String      @db.Uuid

  eventType     String
  payload       Json

  status        OutboxStatus @default(PENDING)
  attempts      Int          @default(0)
  nextAttemptAt DateTime?

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  org           Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([status, nextAttemptAt])
  @@index([orgId, createdAt])
}

model WebhookEndpoint {
  id        String   @id @default(uuid()) @db.Uuid
  orgId     String   @db.Uuid

  url       String
  // Store encrypted secret in app layer, or store as-is for demo
  secret    String
  events    Json     @default("[]")
  active    Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deliveries WebhookDelivery[]

  @@index([orgId, createdAt])
}

model WebhookDelivery {
  id          String                @id @default(uuid()) @db.Uuid
  orgId       String                @db.Uuid
  endpointId  String                @db.Uuid
  eventId     String                @db.Uuid

  status      WebhookDeliveryStatus  @default(PENDING)
  attempts    Int                    @default(0)
  lastError   String?
  responseCode Int?

  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  org        Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  endpoint   WebhookEndpoint @relation(fields: [endpointId], references: [id], onDelete: Cascade)

  @@index([orgId, createdAt])
  @@index([status, updatedAt])
  @@index([endpointId, createdAt])
}
